vars:
  - code_dir: src/probafcst/
  - pipe_dir: src/probafcst/pipeline

stages:
  prepare:
    foreach:
      - energy
      - bikes
    do:
      cmd: uv run python ${pipe_dir}/prepare.py --target ${item}
      params:
        - data.${item}
        - cache
      deps:
        - ${pipe_dir}/prepare.py
        - ${code_dir}/data.py
      outs:
        - data/${item}.parquet
  train:
    foreach:
      - energy
      - bikes
    do:
      cmd: uv run python ${pipe_dir}/train.py --target ${item}
      params:
        - data.${item}
        - quantiles
      deps:
        - data/${item}.parquet
        - ${pipe_dir}/train.py
        - ${code_dir}/model.py
      outs:
        - models/${item}_model.pkl
  eval:
    foreach:
      - energy
      - bikes
    do:
      cmd: uv run python ${pipe_dir}/evaluate.py --target ${item}
      params:
        - eval
      deps:
        - data/${item}.parquet
        - models/${item}_model.pkl
        - ${pipe_dir}/evaluate.py
      outs:
        - output/eval_results_${item}.csv
      plots:
        - output/eval_plots/${item}/
      metrics:
        - output/${item}_metrics.json
  submit:
    cmd: uv run python ${pipe_dir}/submit.py
    params:
      - quantiles
    deps:
      - ${pipe_dir}/submit.py
      - ${code_dir}/utils/check_submission.py
      - ${code_dir}/utils/create_submission.py
      - ${code_dir}/plotting.py
      - models/energy_model.pkl
      - models/bikes_model.pkl
    outs:
      - output/submission.csv
    plots:
      - output/energy_forecast.png
      - output/bikes_forecast.png
